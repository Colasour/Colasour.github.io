(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{287:function(t,s,a){"use strict";a.r(s);var n=a(35),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"frontmatter-title"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#frontmatter-title"}},[t._v("#")]),t._v(" "+t._s(t.$frontmatter.title))]),t._v(" "),n("h2",{attrs:{id:"渲染机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#渲染机制"}},[t._v("#")]),t._v(" 渲染机制")]),t._v(" "),n("p",[t._v("浏览器的渲染机制一般分为以下几个步骤：")]),t._v(" "),n("ol",[n("li",[t._v("处理 HTML 并构建 DOM 树")]),t._v(" "),n("li",[t._v("处理 CSS 构建 CSSOM 树")]),t._v(" "),n("li",[t._v("将 DOM 与 CSSOM 合并成一个渲染树")]),t._v(" "),n("li",[t._v("根据渲染树来布局，计算每个节点的位置")]),t._v(" "),n("li",[t._v("调用 GPU 绘制，合成图层，显示在屏幕上")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(420),alt:"render"}})]),t._v(" "),n("p",[t._v("在构建 CSSOM 树时，会"),n("strong",[t._v("阻塞")]),t._v("渲染，直至 CSSOM 树构建完成。并且构建 CSSOM 树是一个十分消耗性能的过程，所以应该尽量保证层级扁平，减少过度层叠，越是具体的 CSS 选择器，执行速度越慢。")]),t._v(" "),n("p",[t._v("当 HTML 解析到 "),n("code",[t._v("<script>")]),t._v(" 标签时，会"),n("strong",[t._v("暂停")]),t._v("构建 DOM，完成后才会从暂停的地方重新开始。也就是说，如果你想首屏渲染的越快，就越不应该在首屏就加载 JS 文件。并且 CSS 也会影响 JS 的执行，只有当解析完样式表才会执行 JS，所以也可以认为这种情况下，CSS 也会暂停构建 DOM。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(421),alt:"渲染1"}})]),t._v(" "),n("p",[n("img",{attrs:{src:a(422),alt:"渲染2"}})]),t._v(" "),n("h2",{attrs:{id:"图层"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#图层"}},[t._v("#")]),t._v(" 图层")]),t._v(" "),n("p",[t._v("一般来说，可以把普通文档流看成一个图层。特定的属性可以生成一个新的图层。")]),t._v(" "),n("p",[n("strong",[t._v("不同的图层渲染互不影响")]),t._v("，所以对于某些频繁需要渲染的建议单独生成一个新图层，提高性能。但也不能生成过多的图层，会引起反作用。")]),t._v(" "),n("p",[t._v("通过以下几个常用属性可以生成新图层：")]),t._v(" "),n("ul",[n("li",[t._v("3D 变换："),n("code",[t._v("translate3d")]),t._v("、"),n("code",[t._v("translateZ")])]),t._v(" "),n("li",[n("code",[t._v("will-change")])]),t._v(" "),n("li",[n("code",[t._v("video")]),t._v("、"),n("code",[t._v("iframe")]),t._v(" 标签")]),t._v(" "),n("li",[t._v("通过动画实现的 "),n("code",[t._v("opacity")]),t._v(" 动画转换")]),t._v(" "),n("li",[n("code",[t._v("position: fixed")])])]),t._v(" "),n("h2",{attrs:{id:"重绘-repaint-、回流-reflow"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#重绘-repaint-、回流-reflow"}},[t._v("#")]),t._v(" 重绘 (Repaint)、回流 (Reflow)")]),t._v(" "),n("p",[t._v("重绘和回流在渲染过程中对于性能影响很大：")]),t._v(" "),n("ul",[n("li",[n("strong",[t._v("重绘")]),t._v("是当节点需要更改外观而不会影响布局的，比如改变 "),n("code",[t._v("color")])]),t._v(" "),n("li",[n("strong",[t._v("回流")]),t._v("是布局或者几何属性需要改变")])]),t._v(" "),n("blockquote",[n("p",[t._v("回流必定会发生重绘，重绘不一定会引发回流。")])]),t._v(" "),n("p",[t._v("回流所需的成本比重绘高的多，改变深层次的节点很可能导致父节点的一系列回流。因此以下几个动作可能会导致性能问题：")]),t._v(" "),n("ul",[n("li",[t._v("改变 "),n("code",[t._v("window")]),t._v(" 大小")]),t._v(" "),n("li",[t._v("改变字体")]),t._v(" "),n("li",[t._v("添加或删除样式")]),t._v(" "),n("li",[t._v("文字改变")]),t._v(" "),n("li",[t._v("定位或者浮动")]),t._v(" "),n("li",[t._v("盒模型")])]),t._v(" "),n("p",[t._v("❗ 重绘和回流其实和 Event Loop 有关：")]),t._v(" "),n("ol",[n("li",[t._v("当 Event loop 执行完 Microtasks 后，会判断 "),n("code",[t._v("document")]),t._v(" 是否需要更新。因为浏览器是 60Hz 的刷新率，每 16ms 才会更新一次")]),t._v(" "),n("li",[t._v("然后判断是否有 "),n("code",[t._v("resize")]),t._v(" 或者 "),n("code",[t._v("scroll")]),t._v(" ，有的话会去触发事件，所以 "),n("code",[t._v("resize")]),t._v(" 和 "),n("code",[t._v("scroll")]),t._v(" 事件也是至少 16ms 才会触发一次，并且自带节流功能")]),t._v(" "),n("li",[t._v("判断是否触发了 "),n("code",[t._v("media query")])]),t._v(" "),n("li",[t._v("更新动画并且发送事件")]),t._v(" "),n("li",[t._v("判断是否有全屏操作事件")]),t._v(" "),n("li",[t._v("执行 "),n("code",[t._v("requestAnimationFrame")]),t._v(" 回调")]),t._v(" "),n("li",[t._v("执行 "),n("code",[t._v("IntersectionObserver")]),t._v(" 回调，该方法用于判断元素是否可见，可以用于懒加载上，但是兼容性不好")]),t._v(" "),n("li",[t._v("更新界面")]),t._v(" "),n("li",[t._v("以上就是一帧中可能会做的事情。如果在一帧中有空闲时间，就会去执行 "),n("code",[t._v("requestIdleCallback")]),t._v(" 回调")])]),t._v(" "),n("h3",{attrs:{id:"减少重绘和回流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#减少重绘和回流"}},[t._v("#")]),t._v(" 减少重绘和回流")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("使用 translate 替代 top")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("style")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token style"}},[n("span",{pre:!0,attrs:{class:"token language-css"}},[t._v("\n  "),n("span",{pre:!0,attrs:{class:"token selector"}},[t._v(".test")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v("position")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" absolute"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v("top")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10px"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v("width")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 100px"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v("height")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 100px"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v("background")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" red"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("style")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token script"}},[n("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 引起回流")]),t._v("\n    document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.test'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("top "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'100px'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("使用 "),n("code",[t._v("visibility")]),t._v(" 替换 "),n("code",[t._v("display: none")]),t._v(" ，因为前者只会引起重绘，后者会引发回流（改变了布局）")])]),t._v(" "),n("li",[n("p",[t._v("把 DOM 离线后修改，比如先把 DOM 给 "),n("code",[t._v("display:none")]),t._v(" (有一次回流)，修改 100 次，再把它显示出来")])]),t._v(" "),n("li",[n("p",[t._v("不要把 DOM 结点的属性值放在一个循环里当成循环里的变量")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取 offsetTop 会导致回流，因为需要去获取正确的值")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.test'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("style"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("offsetTop"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("不要使用 "),n("code",[t._v("table")]),t._v(" 布局，可能很小的一个小改动会造成整个 "),n("code",[t._v("table")]),t._v(" 的重新布局")])]),t._v(" "),n("li",[n("p",[t._v("动画实现的速度的选择，动画速度越快，回流次数越多，也可以选择使用 "),n("code",[t._v("requestAnimationFrame")])])]),t._v(" "),n("li",[n("p",[t._v("CSS 选择符从右往左匹配查找，避免 DOM 深度过深")])]),t._v(" "),n("li",[n("p",[t._v("将频繁运行的动画变为图层，图层能够阻止该节点回流影响别的元素。比如对于 "),n("code",[t._v("video")]),t._v(" 标签，浏览器会自动将该节点变为图层")]),t._v(" "),n("p",[n("img",{attrs:{src:a(423),alt:"layers-video"}})])])])])}),[],!1,null,null,null);s.default=e.exports},420:function(t,s,a){t.exports=a.p+"assets/img/render.d89574d8.png"},421:function(t,s,a){t.exports=a.p+"assets/img/render1.6604b730.png"},422:function(t,s,a){t.exports=a.p+"assets/img/render2.0baaabb6.png"},423:function(t,s,a){t.exports=a.p+"assets/img/layers-video.cc72ed3b.png"}}]);