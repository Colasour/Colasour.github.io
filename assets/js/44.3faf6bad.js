(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{277:function(t,s,a){"use strict";a.r(s);var n=a(35),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"frontmatter-title"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#frontmatter-title"}},[t._v("#")]),t._v(" "+t._s(t.$frontmatter.title))]),t._v(" "),n("h2",{attrs:{id:"csrf-攻击"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#csrf-攻击"}},[t._v("#")]),t._v(" CSRF 攻击")]),t._v(" "),n("p",[n("strong",[t._v("跨站请求伪造 (Cross-site request forgery, CSRF)")]),t._v("，是指黑客引诱用户打开黑客的网站，在黑客的网站中，利用用户的登录状态发起的跨站请求。")]),t._v(" "),n("p",[t._v("简单来讲，CSRF 攻击就是黑客"),n("strong",[t._v("利用用户的登录状态")]),t._v("，并"),n("strong",[t._v("通过第三方的站点")]),t._v("来做一些坏事。")]),t._v(" "),n("p",[t._v("通常当用户打开了黑客的页面后，黑客有三种方式去实施 CSRF 攻击。")]),t._v(" "),n("p",[t._v("下面以一个网站为例，分析这三种攻击方式都是怎么实施的。")]),t._v(" "),n("p",[t._v("这里假设该网站具有转账功能，可以通过 "),n("code",[t._v("POST")]),t._v(" 或 "),n("code",[t._v("GET")]),t._v(" 来实现转账，转账接口如下所示：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 同时支持 POST 和 GET")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接口")]),t._v("\nhttps"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("example"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("org"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("sendcoin\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//参数")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 目标用户")]),t._v("\nuser\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 目标金额")]),t._v("\nnumber\n")])])]),n("p",[t._v("有了上面的转账接口，就可以来模拟 CSRF 攻击了。")]),t._v(" "),n("h3",{attrs:{id:"自动发起-get-请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自动发起-get-请求"}},[t._v("#")]),t._v(" 自动发起 GET 请求")]),t._v(" "),n("p",[t._v("黑客最容易实施的攻击方式是"),n("strong",[t._v("自动发起 GET 请求")]),t._v("，具体攻击方式可以参考下面这段代码：")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[t._v("\n"),n("span",{pre:!0,attrs:{class:"token doctype"}},[t._v("<!DOCTYPE html>")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("body")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("h1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("黑客的站点：CSRF攻击演示"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("h1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("img")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("https://www.example.org/sendcoin?user=hacker&number=100"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("body")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("p",[t._v("这是黑客页面的 HTML 代码。在这段代码中，黑客将转账的请求接口隐藏在 "),n("code",[t._v("<img>")]),t._v(" 标签内，欺骗浏览器这是一张图片资源。")]),t._v(" "),n("p",[t._v("当该页面被加载时，浏览器会自动发起 "),n("code",[t._v("<img>")]),t._v(" 的资源请求，如果服务器没有对该请求做判断的话，那么服务器就会认为该请求是一个转账请求，于是用户账户上的 100 数额就被转移到黑客的账户上去了。")]),t._v(" "),n("h3",{attrs:{id:"自动发起-post-请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自动发起-post-请求"}},[t._v("#")]),t._v(" 自动发起 POST 请求")]),t._v(" "),n("p",[t._v("除了自动发送 "),n("code",[t._v("GET")]),t._v(" 请求之外，有些服务器的接口是使用 POST 方法的，所以黑客还需要在他的站点上伪造 "),n("code",[t._v("POST")]),t._v(" 请求。")]),t._v(" "),n("p",[t._v("当用户打开黑客的站点时，是自动提交 "),n("code",[t._v("POST")]),t._v(" 请求，具体的方式可以参考下面示例代码：")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token doctype"}},[t._v("<!DOCTYPE html>")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("body")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("h1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("黑客的站点：CSRF攻击演示"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("h1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("form")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("hacker-form"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("action")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("https://www.example.org/sendcoin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("method")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("POST")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hidden"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hacker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hidden"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("number"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("100"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("form")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token script"}},[n("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v(" document"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hacker-form'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("submit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("body")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("html")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("p",[t._v("在这段代码中，可以看到黑客在他的页面中构建了一个隐藏的表单，该表单的内容就是网站的转账接口。")]),t._v(" "),n("p",[t._v("当用户打开该站点之后，这个表单会被自动执行提交；当表单被提交之后，服务器就会执行转账操作。")]),t._v(" "),n("p",[t._v("因此使用构建自动提交表单这种方式，就可以自动实现跨站点 "),n("code",[t._v("POST")]),t._v(" 数据提交。")]),t._v(" "),n("h3",{attrs:{id:"引诱用户点击链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#引诱用户点击链接"}},[t._v("#")]),t._v(" 引诱用户点击链接")]),t._v(" "),n("p",[t._v("除了自动发起 "),n("code",[t._v("GET")]),t._v(" 和 "),n("code",[t._v("POST")]),t._v(" 请求之外，还有一种方式是诱惑用户点击黑客站点上的链接，这种方式通常出现在论坛或者恶意邮件上。")]),t._v(" "),n("p",[t._v("黑客会采用很多方式去诱惑用户点击链接，示例代码如下所示：")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("img")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("width")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("150")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("http://images.xuejuzi.cn/1612/1_161230185104_1.jpg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("img")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("https://www.example.org/sendcoin?user=hacker&number=100"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("taget")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("_blank"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    点击下载美女照片\n  "),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("a")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("p",[t._v("这段黑客站点代码，页面上放了一张美女图片，下面放了图片下载地址，而这个下载地址实际上是黑客用来转账的接口。")]),t._v(" "),n("p",[t._v("一旦用户点击了这个链接，那么他的金额就被转到黑客账户上了。")]),t._v(" "),n("p",[t._v("以上三种就是黑客经常采用的攻击方式。和 XSS 不同的是，CSRF 攻击不需要将恶意代码注入用户的页面，仅仅是利用服务器的漏洞和用户的登录状态来实施攻击。")]),t._v(" "),n("h2",{attrs:{id:"防御措施"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#防御措施"}},[t._v("#")]),t._v(" 防御措施")]),t._v(" "),n("p",[t._v("发起 CSRF 攻击需要三个必要条件：")]),t._v(" "),n("ol",[n("li",[t._v("目标站点一定要有 CSRF 漏洞")]),t._v(" "),n("li",[t._v("用户要登录过目标站点，并且在浏览器上保持有该站点的登录状态")]),t._v(" "),n("li",[t._v("需要用户打开一个第三方站点，可以是黑客的站点，也可以是一些论坛")])]),t._v(" "),n("p",[t._v("满足以上三个条件之后，黑客就可以对用户进行 CSRF 攻击。")]),t._v(" "),n("p",[t._v("其最关键的一点是要能找到服务器的漏洞，所以说对于 CSRF 攻击主要的防护手段是"),n("strong",[t._v("提升服务器的安全性")]),t._v("。")]),t._v(" "),n("p",[t._v("要让服务器避免遭受到 CSRF 攻击，通常有以下几种途径：")]),t._v(" "),n("h3",{attrs:{id:"充分利用好-cookie-的-samesite-属性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#充分利用好-cookie-的-samesite-属性"}},[t._v("#")]),t._v(" 充分利用好 Cookie 的 SameSite 属性")]),t._v(" "),n("p",[t._v("黑客利用用户的登录状态来发起 CSRF 攻击，而 "),n("strong",[t._v("Cookie 正是浏览器和服务器之间维护登录状态的一个关键数据")]),t._v("，因此要阻止 CSRF 攻击，首先就要考虑在 Cookie 上来做文章。")]),t._v(" "),n("p",[t._v("通常 CSRF 攻击都是从第三方站点发起的，要防止 CSRF 攻击，最好能实现从第三方站点发送请求时禁止 Cookie 的发送。")]),t._v(" "),n("p",[t._v("因此在浏览器通过不同来源发送 HTTP 请求时，有如下区别：")]),t._v(" "),n("ul",[n("li",[t._v("如果是从第三方站点发起的请求，那么需要浏览器禁止发送某些关键 Cookie 数据到服务器")]),t._v(" "),n("li",[t._v("如果是同一个站点发起的请求，那么就需要保证 Cookie 数据正常发送")])]),t._v(" "),n("p",[t._v("在 HTTP 响应头中，通过 "),n("code",[t._v("set-cookie")]),t._v(" 字段设置 Cookie 时，可以带上 "),n("code",[t._v("SameSite")]),t._v(" 选项：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cookie"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("P_JAR"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("06")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" expires"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Tue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("19")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Nov"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("06")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("36")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GMT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" path"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" domain"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("google"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" SameSite"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("none\n")])])]),n("p",[n("strong",[t._v("SameSite 选项通常有 Strict、Lax 和 None")]),t._v(" 三个值：")]),t._v(" "),n("ul",[n("li",[n("p",[n("code",[t._v("Strict")])]),t._v(" "),n("p",[t._v("浏览器会完全禁止第三方 Cookie。")])]),t._v(" "),n("li",[n("p",[n("code",[t._v("Lax")])]),t._v(" "),n("p",[t._v("在跨站点的情况下，从第三方站点的链接打开和从第三方站点提交 "),n("code",[t._v("GET")]),t._v(" 方式的表单这两种方式都会携带 Cookie。")]),t._v(" "),n("p",[t._v("但如果在第三方站点中使用 "),n("code",[t._v("POST")]),t._v(" 方法，或者通过 "),n("code",[t._v("<img>")]),t._v("、"),n("code",[t._v("<iframe>")]),t._v(" 等标签加载的 URL，这些场景都不会携带 Cookie。")])]),t._v(" "),n("li",[n("p",[n("code",[t._v("None")])]),t._v(" "),n("p",[t._v("在任何情况下都会发送 Cookie 数据。")])])]),t._v(" "),n("p",[t._v("对于防范 CSRF 攻击，可以针对实际情况将一些关键的 Cookie 设置为 "),n("code",[t._v("Strict")]),t._v(" 或者 "),n("code",[t._v("Lax")]),t._v(" 模式，这样在跨站点请求时，这些关键的 Cookie 就不会被发送到服务器，从而使得黑客的 CSRF 攻击失效。")]),t._v(" "),n("h3",{attrs:{id:"验证请求的来源站点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证请求的来源站点"}},[t._v("#")]),t._v(" 验证请求的来源站点")]),t._v(" "),n("p",[t._v("由于 CSRF 攻击大多来自于第三方站点，因此服务器可以禁止来自第三方站点的请求。这里需要用到 HTTP 请求头中的 "),n("code",[t._v("Referer")]),t._v(" 和 "),n("code",[t._v("Origin")]),t._v(" 属性。")]),t._v(" "),n("p",[n("code",[t._v("Referer")]),t._v(" 是 HTTP 请求头中的一个字段，记录了该 HTTP 请求的来源地址。")]),t._v(" "),n("p",[t._v("虽然可以通过 "),n("code",[t._v("Referer")]),t._v(" 告诉服务器 HTTP 请求的来源，但是有一些场景是不适合将来源 URL 暴露给服务器的，因此浏览器提供给开发者一个选项，可以不用上传 "),n("code",[t._v("Referer")]),t._v(" 值，具体可参考 "),n("code",[t._v("Referrer Policy")]),t._v("。")]),t._v(" "),n("p",[t._v("但在服务器端验证请求头中的 "),n("code",[t._v("Referer")]),t._v(" 并不是太可靠，因此标准委员会又制定了 "),n("code",[t._v("Origin")]),t._v(" 属性。")]),t._v(" "),n("p",[t._v("在一些重要的场合，比如通过 "),n("code",[t._v("XMLHttpRequest")]),t._v("、"),n("code",[t._v("Fecth")]),t._v(" 发起跨站请求或者通过 "),n("code",[t._v("POST")]),t._v(" 方法发送请求时，都会带上 "),n("code",[t._v("Origin")]),t._v(" 属性，如下图：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(397),alt:"CSRF - Origin"}})]),t._v(" "),n("p",[t._v("从上图可以看出，"),n("code",[t._v("Origin")]),t._v(" 属性只包含了域名信息，并没有包含具体的 URL 路径，这是 "),n("code",[t._v("Origin")]),t._v(" 和 "),n("code",[t._v("Referer")]),t._v(" 的一个主要区别。")]),t._v(" "),n("p",[t._v("服务器的策略是优先判断 "),n("code",[t._v("Origin")]),t._v("，如果请求头中没有包含 "),n("code",[t._v("Origin")]),t._v(" 属性，再根据实际情况判断是否使用 "),n("code",[t._v("Referer")]),t._v(" 值。")]),t._v(" "),n("h3",{attrs:{id:"csrf-token"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#csrf-token"}},[t._v("#")]),t._v(" CSRF Token")]),t._v(" "),n("p",[t._v("除了使用以上两种方式来防止 CSRF 攻击之外，还可以采用 CSRF Token 来验证，这个流程比较好理解，大致分为两步。")]),t._v(" "),n("p",[t._v("第一步，在浏览器向服务器发起请求时，服务器生成一个 CSRF Token。CSRF Token 其实就是服务器生成的字符串，然后将该字符串植入到返回的页面中。可以参考下面示例代码：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DOCTYPE")]),t._v(" html"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("html"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("body"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("form action"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://www.example.org/sendcoin"')]),t._v(" method"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"POST"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("input type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hidden"')]),t._v(" name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"csrf-token"')]),t._v(" value"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nc98P987bcpncYhoadjoiydc9ajDlcn"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("input type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"text"')]),t._v(" name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("input type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"text"')]),t._v(" name"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"number"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("input type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"submit"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("form"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("body"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("html"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),n("p",[t._v("第二步，在浏览器端如果要发起转账的请求，那么需要带上页面中的 CSRF Token，然后服务器会验证该 Token 是否合法。")]),t._v(" "),n("p",[t._v("如果是从第三方站点发出的请求，那么将无法获取到 CSRF Token 的值，所以即使发出了请求，服务器也会因为 CSRF Token 不正确而拒绝请求。")])])}),[],!1,null,null,null);s.default=e.exports},397:function(t,s,a){t.exports=a.p+"assets/img/05-csrf-origin.38ac0a8a.png"}}]);